import flet as ft
import json
import os
import subprocess
import sys

def create_settings_view(settings: dict, logic_manager=None):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç view –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ª–æ–≥–∏–∫–∏ –±–æ—Ç–æ–≤.
    """
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ LogicManager
    if logic_manager and hasattr(logic_manager, 'settings') and logic_manager.settings:
        settings = logic_manager.settings
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã MT5
    mt5_mode = "flask"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Flask API –¥–ª—è macOS
    if logic_manager and logic_manager.mt5:
        mt5_mode = logic_manager.mt5.mode
    
    # ----- –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -----
    
    # Telegram
    api_id_input = ft.TextField(label="Telegram API ID", value=settings.get("telegram", {}).get("api_id", ""), password=True)
    api_hash_input = ft.TextField(label="Telegram API Hash", value=settings.get("telegram", {}).get("api_hash", ""), password=True)
    phone_input = ft.TextField(label="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", value=settings.get("telegram", {}).get("phone", ""), hint_text="+79001234567")
    session_file_input = ft.TextField(label="Session File Name", value=settings.get("telegram", {}).get("session_file", "userbot.session"))
    
    # MT5 - –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–ª—è Windows)
    mt5_login_input = ft.TextField(label="MT5 Login", value=settings.get("mt5", {}).get("login", ""))
    mt5_password_input = ft.TextField(label="MT5 Password", value=settings.get("mt5", {}).get("password", ""), password=True)
    mt5_server_input = ft.TextField(label="MT5 Server", value=settings.get("mt5", {}).get("server", ""))
    mt5_path_input = ft.TextField(label="MT5 Path (for Windows)", value=settings.get("mt5", {}).get("path", ""))
    
    # MT5 - Flask API —Ä–µ–∂–∏–º (–¥–ª—è macOS/Linux)
    mt5_flask_url_input = ft.TextField(label="MT5 Server URL", value=settings.get("mt5_server", {}).get("url", "http://10.211.55.3:5000"))
    
    # –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ MT5
    mt5_mode_switch = ft.Switch(label="–õ–æ–∫–∞–ª—å–Ω—ã–π MT5 (Windows)", value=mt5_mode == "local")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    def on_mt5_mode_change(e):
        is_local = mt5_mode_switch.value
        mt5_login_input.visible = is_local
        mt5_password_input.visible = is_local
        mt5_server_input.visible = is_local
        mt5_path_input.visible = is_local
        mt5_flask_url_input.visible = not is_local
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        if hasattr(settings_view, 'page') and settings_view.page:
            settings_view.page.update()
    
    mt5_mode_switch.on_change = on_mt5_mode_change
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–ª–µ–π
    is_local_mode = mt5_mode == "local"
    mt5_login_input.visible = is_local_mode
    mt5_password_input.visible = is_local_mode
    mt5_server_input.visible = is_local_mode
    mt5_path_input.visible = is_local_mode
    mt5_flask_url_input.visible = not is_local_mode

    # GPT
    gpt_key_input = ft.TextField(label="OpenAI API Key", value=settings.get("gpt", {}).get("api_key", ""), password=True)
    
    # Signal Parser
    signal_parser_enabled = ft.Checkbox(label="Enable Signal Parser", value=settings.get("signal_parser", {}).get("enabled", True))
    
    # AI Trader
    ai_trader_enabled = ft.Checkbox(label="Enable AI Trader", value=settings.get("ai_trader", {}).get("enabled", False))
    ai_lot_size = ft.TextField(label="AI Lot Size", value=str(settings.get("ai_trader", {}).get("lot_size", 0.01)))
    ai_live_trading = ft.Checkbox(label="Live Trading", value=settings.get("ai_trader", {}).get("live_trading", False))
    
    # Trading Settings
    trading_lot_size = ft.TextField(label="Default Lot Size", value=str(settings.get("trading", {}).get("lot_size", 0.01)))
    trading_max_risk = ft.TextField(label="Max Risk %", value=str(settings.get("trading", {}).get("max_risk", 2)))
    
    # Breakeven Settings
    breakeven_enabled = ft.Checkbox(label="Enable Breakeven", value=settings.get("breakeven", {}).get("enabled", False))
    breakeven_pips = ft.TextField(label="Breakeven Pips", value=str(settings.get("breakeven", {}).get("pips", 20)))
    
    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    save_button = ft.ElevatedButton(text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", icon="save")
    refresh_button = ft.ElevatedButton(text="–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", icon="refresh", bgcolor="#2196F3")
    test_gpt_button = ft.ElevatedButton(text="–¢–µ—Å—Ç GPT", icon="psychology")
    test_mt5_button = ft.ElevatedButton(text="–¢–µ—Å—Ç MT5", icon="account_balance")
    create_session_button = ft.ElevatedButton(text="–°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é Telegram", icon="telegram", bgcolor="#0088cc", color="white")
    
    # –°—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
    telegram_status = ft.Text("Telegram: –û–§–§–õ–ê–ô–ù", color="#ff6a6a", size=12)
    mt5_status = ft.Text("MT5: –û–§–§–õ–ê–ô–ù", color="#ff6a6a", size=12)
    gpt_status = ft.Text("GPT: –û–§–§–õ–ê–ô–ù", color="#ff6a6a", size=12)
    db_status = ft.Text("Database: –û–§–§–õ–ê–ô–ù", color="#ff6a6a", size=12)
    
    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º
    start_bot_button = ft.ElevatedButton(text="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞", icon="play_arrow", bgcolor="#4CAF50")
    stop_bot_button = ft.ElevatedButton(text="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞", icon="stop", bgcolor="#f44336")
    start_ai_button = ft.ElevatedButton(text="–ó–∞–ø—É—Å—Ç–∏—Ç—å AI Trader", icon="smart_toy", bgcolor="#2196F3")
    stop_ai_button = ft.ElevatedButton(text="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å AI Trader", icon="smart_toy", bgcolor="#FF9800")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats_text = ft.Text("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...", size=14)
    
    # –õ–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
    session_log = ft.Text("", size=12, color="#888888")
    
    # –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    save_status = ft.Text("", size=12, color="#888888")
    
    def refresh_settings():
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        if logic_manager and hasattr(logic_manager, 'settings') and logic_manager.settings:
            current_settings = logic_manager.settings
            
            # –û–±–Ω–æ–≤–ª—è–µ–º Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            telegram_settings = current_settings.get("telegram", {})
            api_id_input.value = telegram_settings.get("api_id", "")
            api_hash_input.value = telegram_settings.get("api_hash", "")
            phone_input.value = telegram_settings.get("phone", "")
            session_file_input.value = telegram_settings.get("session_file", "userbot.session")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º GPT –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            gpt_settings = current_settings.get("gpt", {})
            gpt_key_input.value = gpt_settings.get("api_key", "")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º MT5 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            mt5_settings = current_settings.get("mt5", {})
            mt5_login_input.value = mt5_settings.get("login", "")
            mt5_password_input.value = mt5_settings.get("password", "")
            mt5_server_input.value = mt5_settings.get("server", "")
            mt5_path_input.value = mt5_settings.get("path", "")
            
            mt5_server_settings = current_settings.get("mt5_server", {})
            mt5_flask_url_input.value = mt5_server_settings.get("url", "http://10.211.55.3:5000")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            signal_parser_settings = current_settings.get("signal_parser", {})
            signal_parser_enabled.value = signal_parser_settings.get("enabled", True)
            
            ai_trader_settings = current_settings.get("ai_trader", {})
            ai_trader_enabled.value = ai_trader_settings.get("enabled", False)
            ai_lot_size.value = str(ai_trader_settings.get("lot_size", 0.01))
            ai_live_trading.value = ai_trader_settings.get("live_trading", False)
            
            trading_settings = current_settings.get("trading", {})
            trading_lot_size.value = str(trading_settings.get("lot_size", 0.01))
            trading_max_risk.value = str(trading_settings.get("max_risk", 2))
            
            breakeven_settings = current_settings.get("breakeven", {})
            breakeven_enabled.value = breakeven_settings.get("enabled", False)
            breakeven_pips.value = str(breakeven_settings.get("pips", 20))
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if hasattr(settings_view, 'page') and settings_view.page:
                settings_view.page.update()
    
    def update_statuses():
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤."""
        if logic_manager:
            status = logic_manager.get_bot_status()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
            telegram_status.value = f"Telegram: {'–ü–û–î–ö–õ–Æ–ß–ï–ù' if status['services']['telegram'] else '–û–§–§–õ–ê–ô–ù'}"
            telegram_status.color = "#4CAF50" if status['services']['telegram'] else "#ff6a6a"
            
            mt5_status.value = f"MT5: {'–ü–û–î–ö–õ–Æ–ß–ï–ù' if status['services']['mt5'] else '–û–§–§–õ–ê–ô–ù'}"
            mt5_status.color = "#4CAF50" if status['services']['mt5'] else "#ff6a6a"
            
            gpt_status.value = f"GPT: {'–ü–û–î–ö–õ–Æ–ß–ï–ù' if status['services']['gpt'] else '–û–§–§–õ–ê–ô–ù'}"
            gpt_status.color = "#4CAF50" if status['services']['gpt'] else "#ff6a6a"
            
            db_status.value = f"Database: {'–ü–û–î–ö–õ–Æ–ß–ï–ù' if status['services']['database'] else '–û–§–§–õ–ê–ô–ù'}"
            db_status.color = "#4CAF50" if status['services']['database'] else "#ff6a6a"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats = status.get('stats', {})
            stats_text.value = f"–°–∏–≥–Ω–∞–ª–æ–≤: {stats.get('total_signals', 0)} | –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: {stats.get('successful_trades', 0)} | –ü—Ä–∏–±—ã–ª—å: ${stats.get('total_profit', 0):.2f}"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            start_bot_button.disabled = status['bot_running']
            stop_bot_button.disabled = not status['bot_running']
            start_ai_button.disabled = not status['bot_running'] or status['ai_trader_running']
            stop_ai_button.disabled = not status['ai_trader_running']
            
            if hasattr(settings_view, 'page') and settings_view.page:
                settings_view.page.update()
    
    # –î–∏–∞–ª–æ–≥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram —Å–µ—Å—Å–∏–∏
    code_input = ft.TextField(
        label="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
        hint_text="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS",
        width=200,
        autofocus=True
    )
    
    password_2fa_input = ft.TextField(
        label="–ü–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
        hint_text="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ 2FA",
        password=True,
        width=200
    )
    
    session_dialog_content = ft.Column([
        ft.Text("–°–æ–∑–¥–∞–Ω–∏–µ Telegram —Å–µ—Å—Å–∏–∏", size=18, weight=ft.FontWeight.BOLD),
        ft.Container(height=10),
        ft.Text("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω.", size=14),
        ft.Container(height=20),
        code_input,
        ft.Container(height=10),
        password_2fa_input,
        ft.Container(height=20),
        ft.Row([
            ft.ElevatedButton(
                text="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
                bgcolor="#4CAF50",
                color="white",
                on_click=lambda e: confirm_telegram_code(e)
            ),
            ft.ElevatedButton(
                text="–û—Ç–º–µ–Ω–∞",
                bgcolor="#f44336", 
                color="white",
                on_click=lambda e: close_session_dialog(e)
            )
        ], spacing=10)
    ], spacing=10, width=400)
    
    session_dialog = ft.AlertDialog(
        title=ft.Text("Telegram –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"),
        content=session_dialog_content,
        modal=True
    )
    
    def close_session_dialog(e):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
        session_dialog.open = False
        session_log.value = "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        session_log.color = "#f44336"
        session_log.update()
        if hasattr(settings_view, 'page') and settings_view.page:
            settings_view.page.update()
    
    def confirm_telegram_code(e):
        """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ–¥ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏"""
        try:
            code = (code_input.value or "").strip()
            password_2fa = (password_2fa_input.value or "").strip()
            
            if not code:
                session_log.value = "‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!"
                session_log.color = "#f44336"
                session_log.update()
                return
            
            session_log.value = "üîê –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞..."
            session_log.color = "#2196F3"
            session_log.update()
            
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∫–æ–¥ —á–µ—Ä–µ–∑ LogicManager
            if logic_manager:
                success = logic_manager.confirm_telegram_code(code, password_2fa)
                if success:
                    session_dialog.open = False
                    session_log.value = "‚úÖ Telegram —Å–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!"
                    session_log.color = "#4CAF50"
                    update_statuses()
                else:
                    session_log.value = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
                    session_log.color = "#f44336"
            else:
                session_log.value = "‚ùå LogicManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                session_log.color = "#f44336"
            
            session_log.update()
            if hasattr(settings_view, 'page') and settings_view.page:
                settings_view.page.update()
                
        except Exception as ex:
            session_log.value = f"‚ùå –û—à–∏–±–∫–∞: {str(ex)}"
            session_log.color = "#f44336"
            session_log.update()
    
    def on_create_telegram_session(e):
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é Telegram —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥."""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            api_id = (api_id_input.value or "").strip()
            api_hash = (api_hash_input.value or "").strip()
            phone = (phone_input.value or "").strip()
            
            if not api_id or not api_hash or not phone:
                session_log.value = "‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ API ID, API Hash –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!"
                session_log.color = "#f44336"
                session_log.update()
                return
            
            # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            on_save_settings(None)
            
            session_log.value = "üì± –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è..."
            session_log.color = "#2196F3"
            session_log.update()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ —á–µ—Ä–µ–∑ LogicManager
            if logic_manager:
                success = logic_manager.init_telegram_session(api_id, api_hash, phone)
                if success:
                    # –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
                    code_input.value = ""
                    password_2fa_input.value = ""
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
                    session_dialog.open = True
                    session_log.value = "üì± –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤ –ø–æ—è–≤–∏–≤—à–µ–º—Å—è –æ–∫–Ω–µ."
                    session_log.color = "#4CAF50"
                    
                    if hasattr(settings_view, 'page') and settings_view.page:
                        settings_view.page.overlay.append(session_dialog)
                        settings_view.page.update()
                else:
                    session_log.value = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –¥–∞–Ω–Ω—ã–µ."
                    session_log.color = "#f44336"
            else:
                session_log.value = "‚ùå LogicManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                session_log.color = "#f44336"
            
            session_log.update()
            
        except Exception as e:
            session_log.value = f"‚ùå –û—à–∏–±–∫–∞: {str(e)}"
            session_log.color = "#f44336"
            session_log.update()
    
    def on_save_settings(e):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."""
        try:
            save_status.value = "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
            save_status.color = "#2196F3"
            save_status.update()
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º MT5
            is_local_mode = mt5_mode_switch.value
            
            new_settings = {
                "telegram": {
                    "api_id": api_id_input.value,
                    "api_hash": api_hash_input.value,
                    "phone": phone_input.value,
                    "session_file": session_file_input.value
                },
                "gpt": {
                    "api_key": gpt_key_input.value
                },
                "signal_parser": {
                    "enabled": signal_parser_enabled.value
                },
                "ai_trader": {
                    "enabled": ai_trader_enabled.value,
                    "lot_size": float(ai_lot_size.value) if ai_lot_size.value else 0.01,
                    "live_trading": ai_live_trading.value
                },
                "trading": {
                    "lot_size": float(trading_lot_size.value) if trading_lot_size.value else 0.01,
                    "max_risk": float(trading_max_risk.value) if trading_max_risk.value else 2
                },
                "breakeven": {
                    "enabled": breakeven_enabled.value,
                    "pips": int(breakeven_pips.value) if breakeven_pips.value else 20
                }
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MT5 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if is_local_mode:
                new_settings["mt5"] = {
                    "login": mt5_login_input.value,
                    "password": mt5_password_input.value,
                    "server": mt5_server_input.value,
                    "path": mt5_path_input.value
                }
            else:
                new_settings["mt5_server"] = {
                    "url": mt5_flask_url_input.value
                }
            
            if logic_manager:
                success = logic_manager.update_settings(new_settings)
                if success:
                    save_status.value = "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"
                    save_status.color = "#4CAF50"
                    print("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
                    refresh_settings() # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                else:
                    save_status.value = "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"
                    save_status.color = "#f44336"
                    print("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫!")
            else:
                save_status.value = "‚ùå LogicManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                save_status.color = "#f44336"
            
            save_status.update()
            update_statuses()
            
        except Exception as e:
            save_status.value = f"‚ùå –û—à–∏–±–∫–∞: {str(e)}"
            save_status.color = "#f44336"
            save_status.update()
            print(f"Error saving settings: {e}")
    
    def on_test_gpt(e):
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç GPT API –∫–ª—é—á."""
        if logic_manager and gpt_key_input.value:
            success = logic_manager.test_gpt_key(gpt_key_input.value)
            if success:
                gpt_status.value = "GPT: –ü–û–î–ö–õ–Æ–ß–ï–ù"
                gpt_status.color = "#4CAF50"
            else:
                gpt_status.value = "GPT: –û–®–ò–ë–ö–ê"
                gpt_status.color = "#f44336"
            gpt_status.update()
    
    def on_test_mt5(e):
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MT5."""
        if logic_manager:
            account_info = logic_manager.get_mt5_account_info()
            if account_info:
                mt5_status.value = "MT5: –ü–û–î–ö–õ–Æ–ß–ï–ù"
                mt5_status.color = "#4CAF50"
            else:
                mt5_status.value = "MT5: –û–®–ò–ë–ö–ê"
                mt5_status.color = "#f44336"tatus.update()
    
    def on_start_bot(e):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞."""
        if logic_manager:
            logic_manager.start_services()
            update_statuses()
    
    def on_stop_bot(e):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–æ—Ç–∞."""
        if logic_manager:
            logic_manager.stop_services()
            update_statuses()
    
    def on_start_ai(e):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç AI Trader."""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ AI Trader
        pass
    
    def on_stop_ai(e):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç AI Trader."""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ AI Trader
        pass
    
    # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    save_button.on_click = on_save_settings
    refresh_button.on_click = lambda e: refresh_settings()
    test_gpt_button.on_click = on_test_gpt
    test_mt5_button.on_click = on_test_mt5
    create_session_button.on_click = on_create_telegram_session
    start_bot_button.on_click = on_start_bot
    stop_bot_button.on_click = on_stop_bot
    start_ai_button.on_click = on_start_ai
    stop_ai_button.on_click = on_stop_ai
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    refresh_settings()
    update_statuses()
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    settings_view = ft.Container(
        bgcolor="#1a1a1a",
        padding=24,
        content=ft.Column([
            ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", size=24, weight=ft.FontWeight.BOLD, color="#ffffff"),
            ft.Container(height=24),
            
            # –°–µ–∫—Ü–∏—è MT5
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ MetaTrader 5", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    mt5_mode_switch,
                    ft.Container(height=12),
                    mt5_login_input,
                    mt5_password_input,
                    mt5_server_input,
                    mt5_path_input,
                    mt5_flask_url_input,
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è Telegram
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    api_id_input,
                    api_hash_input,
                    phone_input,
                    session_file_input,
                    create_session_button,
                    session_log,
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è GPT
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GPT", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    gpt_key_input,
                    test_gpt_button,
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    trading_lot_size,
                    trading_max_risk,
                    breakeven_enabled,
                    breakeven_pips,
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è AI Trader
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("AI Trader", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    ai_trader_enabled,
                    ai_lot_size,
                    ai_live_trading,
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    ft.Row([save_button, refresh_button, test_mt5_button], spacing=12),
                    save_status,
                    ft.Container(height=12),
                    ft.Row([start_bot_button, stop_bot_button], spacing=12),
                    ft.Container(height=12),
                    ft.Row([start_ai_button, stop_ai_button], spacing=12),
                ], spacing=12)
            ),
            
            ft.Container(height=16),
            
            # –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
            ft.Container(
                bgcolor="#2a2a2a",
                border_radius=12,
                padding=20,
                content=ft.Column([
                    ft.Text("–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤", size=16, weight=ft.FontWeight.BOLD, color="#ffffff"),
                    ft.Container(height=16),
                    telegram_status,
                    mt5_status,
                    gpt_status,
                    db_status,
                    ft.Container(height=12),
                    stats_text,
                ], spacing=8)
            ),
            
        ], spacing=0, scroll=ft.ScrollMode.AUTO)
    )
    
    return settings_view, [api_id_input, api_hash_input, phone_input, session_file_input,
                          mt5_login_input, mt5_password_input, mt5_server_input, mt5_path_input,
                          mt5_flask_url_input, mt5_mode_switch, gpt_key_input, signal_parser_enabled,
                          ai_trader_enabled, ai_lot_size, ai_live_trading, trading_lot_size,
                          trading_max_risk, breakeven_enabled, breakeven_pips] 